# AsyncTask

Без значение от средата си на изпълнение приложенията като един процес и всички инструкции се изпълняват последователно (синхронно) една след друга. Това води до забавяне в изпълнението на програмите а при задачи който отнемат повече време и до отказ на програмите за известно време. Преодоляването на тези проблеми става посредством паралелно или асинхронно програмиране, при което две задачи могат да се изпълняват едновременно бе те да се засягат или блокират взаимно. В Android приложенията се изпълняват в една нишка която се нарича UIThread, това е нишката която се грижи за взаимодействието с потребителя, ако тя се блокира поради дълъг процес това би дало сигнал на потребителя че има проблем с приложението въпреки че такъв няма. Един от механизмите за решаване на проблемите в синхронното изпълнение на задачи в Android е **AsyncTask**

AsyncTask е механизъм за изпълнение на операции във фонов режим без да се налага ръчна обработка на нишки, създаване или изпълнение. AsyncTasks е предназначен да се използва за кратки операции (най-много няколко секунди).

AsyncTasks обикновено се използва за задачи, които не могат да бъдат извършени на UIThread, като например изтегляне на мрежови данни от API или индексиране на данни от външен източник на устройството. 

AsyncTask опростява следният общ процес за действие:

- Pre - изпълнение на кода на нишката на потребителския интерфейс, преди да започнете задача (например покажи ProgressBar)
- Task - Изпълнение на фонова задача (например извличане на данни)
- Updates - Показване на актуализации на напредъка по време на задачата (по избор)
- Post - Изпълнение на код на UIThread след завършване на задачата (например показване на данни)

Това прави библиотеката Picasso, извлича данните от URL асинхронно и обновява нишката на потребителския интерфейс.

## Дефиниране на асинхронна задача

Създаването на асинхронна задача става като класа който ще изпълнява задачата наследи Android класа AsyncTask

**Пример**

```java
// Типовете, посочени в generic класа, са тип на входните данни, тип на напредъка и тип резултат
public class DownloadImageAsyncTask extends AsyncTask<String, Progress, Bitmap> {
     protected void onPreExecute() {
         // Работи върху UIthread преди doInBackground
         // Подходящ за превключване на видимостта на индикатор за напредък
         progressBar.setVisibility(ProgressBar.VISIBLE);
     }

     protected Bitmap doInBackground(String... strings) {
         // Изпълнение на продължителна задача като изтегляне на изображение.
         Bitmap = downloadImageFromUrl(strings[0]);
         return someBitmap;
     }

     protected void onProgressUpdate(Progress... values) {
        // Изпълнява се всеки път, когато се публикува прогрес извиква се от doInBackground
        // Използва се за актуализиране на индикатора за напредък
        progressBar.setProgress(values[0]);
     }  

     protected void onPostExecute(Bitmap result) {
         // Този метод се изпълнява от UIThread
         // като достъпва резултата от продължителната задача
         imageView.setImageBitmap(result);
         // Скриване на индикатор за напредък
         progressBar.setVisibility(ProgressBar.INVISIBLE);
     }
}
```
# Изпълнение на асинхронната задача

Веднъж определен работник може да се стартира по всяко време чрез създаване на обект от класа и след това се извика метода за стартира задачата:

**Пример**

```java
private void downloadImageAsync() {
    new DownloadImageAsyncTask().execute("http://images.com/image.jpg");
}
```

## Класа AsyncTask 

AsyncTask приема три generic типа, за да информира за работата във фонов режим, която се извършва:

- ```AsyncTask<Params, Progress, Result>```
	- Params - типът, който се предава в метода execute()
    - Progress - типа, който се използва в рамките на задачата за проследяване на напредъка.
    - Result - типа, който се връща от doInBackground() като резултат

Например, задачата изисква въвеждане на низ за изпълнение, не записва проследяване на напредъка и връща растерна графика след завършване на задачата. ```AsyncTask<String, Void, Bitmap>```

Методи на класа AsyncTask:

- ```onPreExecute``` - изпълнява се в основната нишка, за изпълнение на подготвителни действия преди началото на задачата, примерно създаване на началния изглед на лентата за напредъка.
- ```doInBackground``` - изпълнена във фоновa задача, примерно мрежови изтегляния.
- ```onProgressUpdate``` - изпълнява се в основната нишка, извиква се от - `` - ```doInBackground``` - може да се използва за следене на напредъка на задачата.
- ```onPostExecute``` - изпълнява се в основната нишка, обработва се резултата от приключилата задача.

